{% ckan_extends %}

{% block package_description %}
{% endblock %}

{% block package_resources %}
{% endblock %}

{% block page_header %}
  {% if c.userobj %}
    {{ super() }}
  {% endif %}
{% endblock %}

{% block breadcrumb %}
  <div class="row">
    <div class="col-md-6">
      {% snippet 'package/snippets/search.html' %}
    </div>
    <div class="col-md-3 offset-md-3 breadcrumb-right">
      <a href="{% url_for dataset_type ~ '.search' %}" class="btn btn-link breadcrumb-back">
        <img src="/img/icon-arrow-back.png" />
        <span>{{ _('Back to all datasets') }}</span>
      </a>
    </div>
  </div>
{% endblock %}

{% block primary_content_inner %}
  {% if h.mappreview_should_show(pkg) %}
    {% snippet "package/snippets/mappreview.html", pkg=pkg %}
  {% endif %}
 
  <div class="row package-details-row">
    <div class="col-md-6">
      {% snippet "package/snippets/additional_info.html", pkg_dict=pkg %}
    </div>
    <div class="col-md-6">
      {% block package_usage %}
        <div class="package-usage">
          {% block package_citation %}
            {% snippet "package/snippets/textarea_copy.html", title='Cite this dataset', content=pkg_dict.suggested_citation %}
          {% endblock %}
          {% block package_map_embed %}
            {% snippet "package/snippets/textarea_copy.html", title='Embed this layer into your website', content=h.mappreview_generate_map_code(pkg_dict), extra_class='mono' %}
          {% endblock %}
          {% block package_code_copy %}
            {% snippet "package/snippets/textarea_copy.html", title='Use this data in Python', content=h.mappreview_generate_usage_code(pkg_dict), extra_class='mono' %}
          {% endblock %}
        </div>
      {% endblock %}
    </div>
  </div>
{% endblock %}

{# 1) drop the modal on the page #}
{% block secondary_content %}
  {{ super() }}
  <div class="modal fade" id="metadataModal" tabindex="-1" aria-labelledby="metadataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
  
        <div class="modal-header">
          <h4 class="modal-title" id="metadataModalLabel">Metadata</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          </button>
        </div>
  
        <div class="modal-body">
          <pre id="metadataModalBody"
               class="pre-scrollable"
               style="white-space:pre-wrap; margin:0; max-height:60vh;">Loading…</pre>
        </div>
  
        <div class="modal-footer">
          <a id="metadataDownloadLink" class="btn btn-secondary" href="#" download>Download .yml</a>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
        </div>
  
      </div>
    </div>
  </div>
  
{% endblock %}

{# 2) inline JS that wires the preview button to the modal #}
{% block scripts %}
  {{ super() }}
  <script>
    (function () {
      // Hoist the modal to <body> so it isn't trapped under map/search stacking elements
      var modalEl = document.getElementById('metadataModal');
      if (modalEl && modalEl.parentNode !== document.body) {
        document.body.appendChild(modalEl);
      }

      // click handler
      document.addEventListener('click', function (evt) {
        var btn = evt.target.closest('.js-metadata-preview');
        if (!btn) return;

        evt.preventDefault();

        var metaName = btn.getAttribute('data-meta-name') || 'Metadata';
        var metaUrl  = btn.getAttribute('data-meta-url');
        if (!metaUrl) return;

        var bodyEl  = document.getElementById('metadataModalBody');
        var titleEl = document.getElementById('metadataModalLabel');
        var dlEl    = document.getElementById('metadataDownloadLink');
        var modal   = document.getElementById('metadataModal');

        if (titleEl) titleEl.textContent = metaName;
        if (dlEl)    dlEl.setAttribute('href', metaUrl);
        if (bodyEl)  bodyEl.textContent = 'Loading…';

        fetch(metaUrl, { credentials: 'same-origin' })
          .then(function (r) { return r.text(); })
          .then(function (txt) { if (bodyEl) bodyEl.textContent = txt; })
          .catch(function (e)  {
            if (bodyEl) bodyEl.textContent = 'Failed to load metadata.\n\n' + e;
          })
          .finally(function () {
            if (!modal) return;

            // Bootstrap 5
            if (window.bootstrap && bootstrap.Modal) {
              var instance = bootstrap.Modal.getOrCreateInstance(modal);
              instance.show();
              return;
            }

            // Bootstrap 3/4 fallback
            if (window.jQuery && typeof jQuery(modal).modal === 'function') {
              jQuery(modal).modal('show');
              return;
            }

            modal.style.display = 'block';
          });
      }, false);
    })();
  </script>
{% endblock %}


